@page "/"
@using System.Text.Json
@using GridEditorLib
@using MapsLib.Services

@inject MapService mapService
@inject MapGridJsInterop mapGrid
@rendermode InteractiveServer

<div>
    <div>
        <button @onclick="EmptyAsync">Empty</button>
        <button @onclick="LoadAsync">Load</button>
        <button @onclick="SaveAsync">Save</button>
        <TileSelector @bind-Type="@TileType"></TileSelector>
    </div>
    <div>
        <MapGrid></MapGrid>
    </div>
</div>
@code {
    private DotNetObjectReference<Home>? pageProxy;

    private byte tileType;

    public byte TileType {
        get => tileType;
        set {
            tileType = value;
            mapGrid.SetTileTypeAsync(tileType).Wait();
        }
    }

    async Task EmptyAsync()
    {
        try
        {
            await mapGrid.SetTileTypeAsync(0);
            await mapService.EmptyAsync(50, 50);
            await mapGrid.LoadAsync(mapService.Width, mapService.Height, mapService.Values());
        }
        catch(Exception ex)
        {
            Console.WriteLine($"Error during EmptyAsync: {ex.Message}");
        }
    }

    async Task LoadAsync()
    {
        try
        {
            using var stream = new FileStream(@"Levels\06\map.json", FileMode.Open);
            await mapService.LoadAsync(stream);
            await mapGrid.LoadAsync(mapService.Width, mapService.Height, mapService.Values());
            stream.Close();
        }
        catch(Exception ex)
        {
            Console.WriteLine($"Error during LoadAsync: {ex.Message}");
        }   
    }

    async Task SaveAsync()
    {
        using var stream = new FileStream(@"D:\MarcoSoft\MapExperiments\MapApp\Levels\06\map.json", FileMode.Create);
        await mapService.SaveAsync(stream);
        stream.Close();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                pageProxy = DotNetObjectReference.Create(this);
                var tilesetImage = File.ReadAllBytes(@"Levels\06\tiles.png");
                await mapGrid.SetupAsync(pageProxy, "canvas", tilesetImage);
                await EmptyAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error during OnAfterRenderAsync: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public async Task SetXYAsync(JsonElement x, JsonElement y, JsonElement tileType)
    {
        if (x.TryGetInt32(out var xValue) && y.TryGetInt32(out var yValue) && tileType.TryGetByte(out var tileTypeValue))
        {
            mapService.Set(xValue, yValue, tileTypeValue);
        }
    }

    public void Dispose() => pageProxy?.Dispose();
}